
# Joint Structure-Function Modeling of the Human Connectome to Predict Intelligence
This repository contains the scripts for applying joint structure-function circuit analysis to predicting intelligence scores using the Human Connectome Project's (HCP) Young Adult dataset. It is associated with the following article:
```
Wilcox, R. R., Hemmatian, B., Varsheny, L. R., & Barbey, A. K. (2025). The Network Architecture of General Intelligence in the Human Connectome."
```
## Overview
The scripts may be used to:    
  1) Process resting-state and diffusion-weighted MRI data.   
  2) Run independent component analysis (ICA) on the resting-state data.   
  3) Threshold and classify spatial components from the ICA.  
  4) Perform tractography using the Glasser-360 atlas.    
  5) Jointly model ICA spatial components with structural connectomes.   
  6) Run the main brain-behavior analyses in the mentioned paper.
    
Any questions or concerns should be sent to [rwilcox@nd.edu](mailto:rwilcox@nd.edu).

## System Preparation
In your compute environment, you will need to install the following programs with the indicated version numbers before running the ```'1_MRI_Processing``` scripts within the ```scripts``` folder:
```
Matlab r2019b
FSL 6.0.6
FreeSurfer 7.4.1
AFNI 23.1
ANTS 2.5.1
mrtrix3 3.0.4
mrtrix3tissue 5.2.9
connectome-workbench 2.0.1
ibm-ilog-cplex 12.10
```
In addition, you will need to create a conda environment from the ```mri_conda_env.yml``` file located in the repository's main folder. The scripts expect the environment to have the name ```mri_conda_env``` and should be stored in the main folder (see example tree below).

The majority of scripts in ```3_Brain_Behavior_Analyses``` were run in ```R==4.5.1```. You simply need to install the packages listed in ```requirements.r```.

In addition, there are two ```3_Brain_Behavior_Analyses``` scripts that use ```python==3.9.23```. You will need to install the packages listed in ```requirements_py3.txt``` for these to run correctly. The scripts in this folder do not require a high-performance compute environment and can be run on most local machines.

## Data Preparation
Data can be downloaded from the Human Connectome Project's 1200 Young Adult dataset [here](https://db.humanconnectome.org). You will need to create an account before downloading. Specifically, download the following:
1) unrestricted behavioral data,
2) structural preprocessed data,
3) resting state fMRI 1 preprocessed,
4) resting state fMRI 2 preprocessed,
5) diffusion preprocessed packages.

You do not need to manually unzip the subject folders, as the scripts will do that for you. You only need to place the data files in their relevant folders.
For example, the resting state data goes in ```/JSFM_Intelligence_HCP/data/preprocessed/rest```. 

In addition, when you download the behavioral data, it will have a unique name. You will need to rename this file to ```unrestricted_data.csv```.

All other necessary data files are provided in this repository. If you notice something is missing, please contact us.

We have provided at the end of this document an example tree of what things should look like before running the scripts. Note that we have only included one subject's MRI data folders for brevity.

## Running the Scripts
The code has been split into three main folders with leading numbers describing the order in which they should be run. The leading numbers in the names of scripts within each folder similarly indicate the order in which tasks should be performed. Please see the readme file within each folder for more information about each script's environment and procedures. 

## Acknowledgement
The network modeling approach is adapted from the following article based on author-provided scripts:
```
"Chu, S. H., Parhi, K. K., & Lenglet, C. (2018). Function-specific and enhanced brain structural connectivity mapping via joint modeling of diffusion and functional MRI.*Scientific Reports*. "[https://www.nature.com/articles/s41598-018-23051-9](https://www.nature.com/articles/s41598-018-23051-9)
```
## Example Directory Tree
```console
.
????????? data
???   ????????? behavioral
???   ???   ????????? unrestricted_data.csv
???   ????????? graph_metrics
???   ????????? ICA
???   ????????? jsfm
???   ???   ????????? master_files
???   ????????? mri_qaqc
???   ????????? parcellations
???   ???   ????????? cortex_parcel_network_assignments.txt
???   ???   ????????? MMP1_MNI_lh.label.gii
???   ???   ????????? MMP1_MNI_rh.label.gii
???   ????????? preprocessed
???   ???   ????????? anat
???   ???   ???   ????????? 100206_3T_Structural_preproc.zip
???   ???   ????????? dwi
???   ???   ???   ????????? 100206_3T_Diffusion_preproc.zip
???   ???   ????????? rest
???   ???       ????????? 100206_3T_rfMRI_REST1_preproc.zip
???   ???       ????????? 100206_3T_rfMRI_REST2_preproc.zip
???   ????????? tractography
???       ????????? master_files
????????? mri_conda_env
????????? out_batch
????????? README.md
????????? requirements_py3.txt
????????? requirements.r
????????? results
???   ????????? lesion
???   ???   ????????? exclusion
???   ???   ????????? inclusion
???   ????????? permutation
????????? scripts
    ????????? 1_MRI_Processing
    ???   ????????? 10_parallel_tractography.sh
    ???   ????????? 11_parallel_structural_connectome.sh
    ???   ????????? 12_connectome_mu_scale.r
    ???   ????????? 13_parallel_structural_distome.sh
    ???   ????????? 14_Generate_RMS_List.sh
    ???   ????????? 1_parallel_smooth_HP_detrend.sh
    ???   ????????? 2_parallel_melodic-ica.sh
    ???   ????????? 3_parallel_ica-threshold.sh
    ???   ????????? 4_parallel_parcellation_registration.sh
    ???   ????????? 5_parallel_ICA_component_classification.sh
    ???   ????????? 6_parallel_generate_r_matrices.sh
    ???   ????????? 7_parallel_preprocess_dwi.sh
    ???   ????????? 8_GroupAverageResponseFunctionGeneration.sh
    ???   ????????? 9_parallel_FOD_estimation.sh
    ???   ????????? README.md
    ???   ????????? utils
    ???       ????????? generate_r_matrices.py
    ???       ????????? ICA_Component_Classification.py
    ???       ????????? single_subj_FOD_estimation.sh
    ???       ????????? single_subj_generate_r_matrices.sh
    ???       ????????? single_subj_ICA_component_classification.sh
    ???       ????????? single_subj_ica-threshold.sh
    ???       ????????? single_subj_melodic-ica.sh
    ???       ????????? single_subj_parcellation_registration.sh
    ???       ????????? single_subj_preprocess_dwi.sh
    ???       ????????? single_subj_smooth_HP_detrend.sh
    ???       ????????? single_subj_structural_connectome.sh
    ???       ????????? single_subj_structural_distome.sh
    ???       ????????? single_subj_tractography.sh
    ???       ????????? threshold_parcellation.py
    ????????? 2_Joint_Structure_Function_Modeling
    ???   ????????? BNIF
    ???   ???   ????????? 1_parallel_BNIF.sh
    ???   ???   ????????? utils
    ???   ???       ????????? BNIF_optimized.m
    ???   ???       ????????? run_BNIF.m
    ???   ???       ????????? single_subj_BNIF.sh
    ???   ????????? README.md
    ????????? 3_Brain_Behavior_Analyses
        ????????? 10_create_group_averaged_structural_distome.r
        ????????? 11_generate_network_connection_header_map.r
        ????????? 12_stratified_k_fold_elastic_net.r
        ????????? 13_create_stable_significant_connections.r
        ????????? 14_create_permuted_g_scores.r
        ????????? 15_stratified_k_fold_elastic_net_PERMUTATION.r
        ????????? 16_stratified_k_fold_elastic_net_INCLUSION.r
        ????????? 17_stratified_k_fold_elastic_net_EXCLUSION.r
        ????????? 18_weak_ties_analysis.r
        ????????? 19_modal_control_analysis.r
        ????????? 1_factor_analysis.r
        ????????? 20_small_worldness_analysis.r
        ????????? 2_create_sparsity_master.r
        ????????? 3_create_jsfm_averaged_subject_matrices.r
        ????????? 4_generate_good_subjects.r
        ????????? 5_create_jsfm_master.r
        ????????? 6_create_distome_master.r
        ????????? 7_small_world_telesford.py
        ????????? 8_modal_control.py
        ????????? 9_create_group_averaged_structure_function_network.r
        ????????? README.md
```
